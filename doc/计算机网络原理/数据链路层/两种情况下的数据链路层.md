# 两种情况下的数据链路层

## 1. 使用点对点信道的数据链路层 - 广域网 - PPP 协议

### 1.1 PPP(Point-to-Point Protocol) - 点对点协议

用户使用拨号电话线接入因特网时，一般使用PPP协议。

PPP协议应该满足的要求：
* 简单 - 这是首要要求
* 封装成帧
* 透明性
* 多种网络层协议
* 多种类型链路
* 差错检测
* 检测连接状态
* 最大传送单元
* 网络层地址协商
* 数据压缩协商

PPP 协议不需要满足的要求：
* 纠错
* 流量控制
* 序号
* 多点线路
* 半双工或单工链路

### 1.2 PPP 协议的组成

PPP协议由三个组成部分：
* 数据链路层协议可以用于异步串行或同步串行介质
* 它使用 LCP（链路控制协议）简历并维护数据链路连接 - 身份验证、记录
* 网络控制协议（NCP）允许在点到点连接上使用多种网络层协议，如图所示

![computer-33.png](/doc/imgs/computer/computer-33.png)

### 1.3 PPP协议帧格式

![computer-34.png](/doc/imgs/computer/computer-34.png)

* 标志字段 F = 0x7E （符号“0x”表示后面的字符用十六进制表示）；7E的二进制为 01111110
* 地址字段 A 只设置为 0xFF，地址字段实际上并不起作用。
* 控制字段 C 通常设置为 0x33
* PPP 是面向字节的，所有的PPP帧的长度都是整数字节

### 1.4 字节填充

信息字段出现标志字段的值，可能被认为是“标志”，解决方法 - 字节填充

* 将信息字段中出现的每个 0x7E 字节转变为2字节序列（0x7D, 0x5E）
* 若信息字段中出现以恶搞 0x7D 的字节，则将其转变成为2字节序列(0x7D, 0x5D
* 若信息字段中出现 ASCII 码的控制字符（即数值小于0x20的字符），则在该字符前面添加一个 0x7D 字节，同时将
  该字符的编码加以改变。
  
### 1.5 零比特填充

PPP协议用在 SONET/SDH 链路时，是使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。

在发送端，只要发现有5个连续1，则立即填入一个0.接收端对帧中的比特流进行扫描。每当发现5个连续1时，就把这5个连续1后的一个0删除。

![computer-35.png](/doc/imgs/computer/computer-35.png)

### 1.6 不使用序号和确认机制

* 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理
* 在因特网环境下，PPP 的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证
   网络层的传输也是可靠的。
* 帧检验序列 FCS 字段可保证无差错接受。

### 1.7 PPP 协议的工作状态

当用户拨号进入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。

PC机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）

这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP 给新接入的 PC 机分配一个临时的IP地址，
使PC机成为因特网上的一个主机。

通信完毕时，NCP 释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的是物理层的连接。

## 2. 使用广播信道的数据链路层 - 局域网（总线型和集线型）- CSMD/CD协议

### 2.1 局域网的拓扑

![computer-36.png](/doc/imgs/computer/computer-36.png)

### 2.2 共享通信媒体

静态划分信道
* 频分复用
* 时分复用
* 波分复用
* 码分复用

动态媒体接入控制（多点接入）
* 随机接入 - 主要被以太网采用 - 普遍被使用
* 受控接入 - 如多点线路探询（polling），如轮询（目前已不被采用）

### 2.3 载波监听多点接入/碰撞检测 - 以太网使用 CSMD/CD协议

CSMA/CD - Carrier Sense Multiple Access with Collision Detection

* 多点接入：表示许多计算机以多点接入的方式连接在一根总线上。
* 载波监听：每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据。如果有，则暂时不要发送数据，以免发生碰撞。
  载波监听就是用电子技术检测总线上有没有其他计算机发送的数据信号。
  
**碰撞检测（冲突检测）**

碰撞检测就是计算机边发送数据边检测信道上的信号电压大小。
* 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）
* 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。

**检测到碰撞后**
* 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中回复出有用的信息来。
* 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。

### 2.4 传播时延对载波监听的影响

![computer-38.png](/doc/imgs/computer/computer-38.png)

重要特性：
* 使用 CSMA/CD协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）。
* 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。
* 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。

### 2.5 争用期和最短有效帧长

最先发送数据帧的站，在发送数据帧后至多经过时间 2t （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。

经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

**以太网的争用期：**
* 以太网的端到端往返时间 2t 称为争用期或碰撞窗口。（取 51.2微秒为争用期的长度）
* 对于 10 Mb/s 以太网，在争用期内科发送 512 比特，即64字节
* 以太网在发送数据时，若前64字节未发生冲突，则后续的数据就不会发生冲突。

**最短有效帧长：**
* 如果发生饿了冲突，就一定是在发送的前64字节之内
* 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于64字节。
* 以太网规定了最短有效帧长为64字节，凡长度小于64字节的帧都是由于冲突而异常中止的无效帧。

### 2.6 二进制指数类型退避算法

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据
* 确定基本退避时间，一般取争用期 2t
* 定义参数 k ===》 k = Min[重传次数，10]
* 从整数集合[0, 1, ..., (2^k -1)]中随机抽出一个数，记为r。重传所需的时延就是r倍的基本退避时间
* 当重传达16次仍不能成功时即丢弃该帧，并向高层报告